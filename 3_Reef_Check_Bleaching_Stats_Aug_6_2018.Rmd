---
title: "Reef Check Bleaching"
author: "SS and RvW"
date: "December 7, 2017"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r load_libraries}
library(MASS)
library(audio)
library(sp)
library(foreign)
library(rgdal)
library(maptools)
library(rgeos)
library(doParallel)
library(rasterVis)
library(dismo)
library(plotKML)
library(SDMTools)
library(PBSmapping)
library(lme4)
library(blme)
library(raster)
library(fields)
library(RColorBrewer)
library(sjmisc)
library(ncdf4)
library(knitr)
library(stringr)
library(ggplot2)
library(wesanderson)
library(cowplot)
library(dplyr)
library(maptools)
library(plotrix)
library(GISTools)
```

```{r set directories and read in files}
main_working_directory="C:/Users/Shannon/Desktop/Ecoregions"
ecoregion_polygons_directory="C:/Users/Shannon/Desktop/Ecoregions/ecoregion_exportPolygon"
graphs_directory="C:/Users/Shannon/Desktop/Ecoregions/output"


setwd(main_working_directory)
Reef_Check_Bleaching_Data <- read.csv(file="Reef Check Data Raw.csv", header=TRUE, sep=",")
ECO<-readOGR(ecoregion_polygons_directory,"ecoregion_exportPolygon")
#ECO= readOGR("C:/RobsR/Shannon")
```

names(Reef_Check_Bleaching_Data)[names(Reef_Check_Bleaching_Data)=="ï..Reef.ID"]<-"Reef.ID"

```{r format lat and lon}

for (i in 1:length(Reef_Check_Bleaching_Data$Longitude.Degrees)){
  cell<-as.double(Reef_Check_Bleaching_Data$Longitude.Degrees[i])+ as.double(Reef_Check_Bleaching_Data$Longitude.Minutes[i]/60)+ as.double(Reef_Check_Bleaching_Data$Longitude.Seconds[i]/60/60)
  if (Reef_Check_Bleaching_Data$Longitude.Cardinal.Direction[i]=='W'){cell<-cell*-1}
  Reef_Check_Bleaching_Data$Longitude.Degrees[i]<-cell
}
for (i in 1:length(Reef_Check_Bleaching_Data$Latitude.Degrees)){
  cell<-as.double(Reef_Check_Bleaching_Data$Latitude.Degrees[i])+ as.double(Reef_Check_Bleaching_Data$Latitude.Minutes[i]/60)+ as.double(Reef_Check_Bleaching_Data$Latitude.Seconds[i]/60/60)
  if (Reef_Check_Bleaching_Data$Latitude.Cardinal.Direction[i]=='S'){cell<-cell*-1}
  Reef_Check_Bleaching_Data$Latitude.Degrees[i]<-cell
}

Reef_Check_Bleaching_Data = subset(Reef_Check_Bleaching_Data, select = -c(Latitude.Minutes,Latitude.Seconds,Latitude.Cardinal.Direction, Longitude.Minutes, Longitude.Seconds, Longitude.Cardinal.Direction))
```

```{r calculate average bleaching}
average_bleaching<-array(data=NA,dim=length(Reef_Check_Bleaching_Data$S1))
for (i in 1:length(average_bleaching)){
num.transects<-0
bleaching_sum<-0
if (is.na(Reef_Check_Bleaching_Data$S1[i])==FALSE){num.transects=num.transects+1; bleaching_sum<-bleaching_sum+Reef_Check_Bleaching_Data$S1[i]}
if (is.na(Reef_Check_Bleaching_Data$S2[i])==FALSE){num.transects=num.transects+1; bleaching_sum<-bleaching_sum+Reef_Check_Bleaching_Data$S2[i]}
if (is.na(Reef_Check_Bleaching_Data$S3[i])==FALSE){num.transects=num.transects+1; bleaching_sum<-bleaching_sum+Reef_Check_Bleaching_Data$S3[i]}
if (is.na(Reef_Check_Bleaching_Data$S4[i])==FALSE){num.transects=num.transects+1; bleaching_sum<-bleaching_sum+Reef_Check_Bleaching_Data$S4[i]}
average_bleaching[i]<-bleaching_sum/num.transects
}
Reef_Check_Bleaching_Data$Average_bleaching<-as.double(average_bleaching)
```

```{r determine study month}

Reef_Check_Bleaching_Data$month<-0
for (i in 1:(dim(Reef_Check_Bleaching_Data)[1]))
{
date_string<-str_split(Reef_Check_Bleaching_Data$Date[i], "-")
month_string<-date_string[[1]][2]
if (month_string=="Jan"){month=1}
if (month_string=="Feb"){month=2}
if (month_string=="Mar"){month=3}
if (month_string=="Apr"){month=4}
if (month_string=="May"){month=5}
if (month_string=="Jun"){month=6}
if (month_string=="Jul"){month=7}
if (month_string=="Aug"){month=8}
if (month_string=="Sep"){month=9}
if (month_string=="Oct"){month=10}
if (month_string=="Nov"){month=11}
if (month_string=="Dec"){month=12}
Reef_Check_Bleaching_Data$month[i]<-month
}

```

```{r use only the population bleaching data, not colony data. remove data pts that have no lat or lon}
population_rows<-which(Reef_Check_Bleaching_Data$Organism.Code=="Bleaching (% of population)")
Reef_Check_Bleaching_Data<-data.frame(Reef_Check_Bleaching_Data[population_rows,])

Reef_Check_Bleaching_Data<-subset(Reef_Check_Bleaching_Data, !is.na(Longitude.Degrees))
Reef_Check_Bleaching_Data<-subset(Reef_Check_Bleaching_Data, !is.na(Latitude.Degrees))
```


#plot.map function copied from "Map preparation code Chris C.R"
```{r plotmap_function}
plot.map<- function(database,center,transf=T,...){
  Obj <- map(database,...,plot=F)
  coord <- cbind(Obj[[1]],Obj[[2]])
  newproj <- "+proj=merc +lon_0=150 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs" #utm
  nextproj<-"+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0" #latlong
  # split up the coordinates
  id <- rle(!is.na(coord[,1]))
  id <- matrix(c(1,cumsum(id$lengths)),ncol=2,byrow=T)
  polygons <- apply(id,1,function(i){coord[i[1]:i[2],]})
  
  # split up polygons that differ too much
  polygons <- lapply(polygons,function(x){
    x[,1] <- x[,1] + center
    x[,1] <- ifelse(x[,1]>180,x[,1]-360,x[,1])
    if(sum(diff(x[,1])>300,na.rm=T) >0){
      id <- x[,1] < 0
      x <- rbind(x[id,],c(NA,NA),x[!id,])
    }
    x
  })
  # reconstruct the object
  polygons <- do.call(rbind,polygons)
  
  
  colnames(polygons)<-c("x",'y')
  polygons<-as.data.frame(polygons)
  z<-complete.cases(polygons)
  p<-z
  z<-cbind(z,z)
  polygons<-polygons[complete.cases(polygons),]
  coordinates(polygons)<-~x+y
  proj4string(polygons)<-CRS(nextproj)
  if(transf==T){ polygons<-spTransform(polygons,CRS(newproj))}
  
  z[p==F,]<-c(NA,NA)
  z[which(p==T),]<-coordinates(polygons)
  Obj[[1]] <- z[,1]
  Obj[[2]] <- z[,2]
  
  map(Obj,...)
}
```

```{r some preliminary checks and dimensions}
dim(Reef_Check_Bleaching_Data) #9215 19
#note. before removing data pts that were missing lat or lon, dims were 9240 19

#Reef.Name
length(levels(Reef_Check_Bleaching_Data$Reef.Name)) #3351
sum(Reef_Check_Bleaching_Data$Reef.Name=="") #0
sum(is.na(Reef_Check_Bleaching_Data$Reef.Name)) #0

#Ocean
levels(Reef_Check_Bleaching_Data$Ocean) #7 [blank], Arabian Gulf, Atlantic, East Pacific, Indian, Pacific, Red Sea
sum(Reef_Check_Bleaching_Data$Ocean=="") #21
sum(is.na(Reef_Check_Bleaching_Data$Ocean)) #0

#Country
length(levels(Reef_Check_Bleaching_Data$Country)) #81
sum(Reef_Check_Bleaching_Data$Country=="") #0
sum(is.na(Reef_Check_Bleaching_Data$Country)) #0

#State.Province.Island
length(levels(Reef_Check_Bleaching_Data$State.Province.Island)) #461
sum(Reef_Check_Bleaching_Data$State.Province.Island=="") #983
sum(is.na(Reef_Check_Bleaching_Data$State.Province.Island)) #0

#City.Town
length(levels(Reef_Check_Bleaching_Data$City.Town)) #837
sum(Reef_Check_Bleaching_Data$City.Town=="") #2253
sum(is.na(Reef_Check_Bleaching_Data$City.Town)) #0

#Year
min(Reef_Check_Bleaching_Data$Year) #1998
max(Reef_Check_Bleaching_Data$Year) #2017
sum(Reef_Check_Bleaching_Data$Year=="") #0
sum(is.na(Reef_Check_Bleaching_Data$Year)) #0

#Depth
min(Reef_Check_Bleaching_Data$Depth) #0.1
max(Reef_Check_Bleaching_Data$Depth) #23
sum(Reef_Check_Bleaching_Data$Depth=="") #0
sum(is.na(Reef_Check_Bleaching_Data$Depth)) #0

#Organism code
#note to self: before filtering down and removing data pts that were missing lat or lon, I found
#sum(Reef_Check_Bleaching_Data$Organism.Code=="Bleaching (% of colony)") #8971
#sum(Reef_Check_Bleaching_Data$Organism.Code=="Bleaching (% of population)") #9240

#S1, S2, S3, S4: up to 4 surveys were done at each location
sum(is.na(Reef_Check_Bleaching_Data$S1)) #9
sum(is.na(Reef_Check_Bleaching_Data$S2)) #12
sum(is.na(Reef_Check_Bleaching_Data$S3)) #70
sum(is.na(Reef_Check_Bleaching_Data$S4)) #107
```

```{r Latitude frequency histogram}
setwd(graphs_directory)
steps_lat<-5
break_pts_lat<-seq(floor(min(na.omit(Reef_Check_Bleaching_Data$Latitude.Degrees)))-.5, ceiling(max(na.omit(Reef_Check_Bleaching_Data$Latitude.Degrees)))+steps_lat+.5, steps_lat)
tiff("Reef Check Latitude Frequency Histogram.tif",res=300,width=2600,height=1000)
hist(na.omit(Reef_Check_Bleaching_Data$Latitude.Degrees), xlab="Latitude", ylab="Frequency", breaks=break_pts_lat, main="Latitude Frequency")
dev.off()
setwd(main_working_directory)
```

```{r Longitude frequency histogram}
setwd(graphs_directory)
steps_lon<-5
break_pts_lon<-seq(floor(min(na.omit(Reef_Check_Bleaching_Data$Longitude.Degrees)))-.5, ceiling(max(na.omit(Reef_Check_Bleaching_Data$Longitude.Degrees)))+steps_lon+.5, steps_lon)
tiff("Reef Check Longitude Frequency Histogram.tif",res=300,width=2600,height=1000)
hist(na.omit(Reef_Check_Bleaching_Data$Longitude.Degrees), xlab="Longitude", ylab="Frequency", main="Longitude Frequency", breaks=break_pts_lon)
dev.off()
setwd(main_working_directory)
```

```{r Month frequency histogram}
setwd(graphs_directory)
break_pts_month<-c(0.5:12.5)
tiff("Reef Check Month Frequency Histogram.tif",res=300,width=2600,height=1000)
hist(na.omit(Reef_Check_Bleaching_Data$month), xlab="Month", ylab="Frequency", main="Study Month Frequency", breaks=break_pts_month)
dev.off()
setwd(main_working_directory)
```

```{r Year frequency histogram}
range_year<-max(na.omit(Reef_Check_Bleaching_Data$Year))-min(na.omit(Reef_Check_Bleaching_Data$Year))
break_pts_year<-seq(min(na.omit(Reef_Check_Bleaching_Data$Year))-.5, max(na.omit(Reef_Check_Bleaching_Data$Year))+.5)
setwd(graphs_directory)
tiff("Reef Check Study Year Frequency Histogram.tif",res=300,width=2600,height=1000)
hist(na.omit(Reef_Check_Bleaching_Data$Year), xlab="Year", ylab="Frequency", main="Studies in each year", breaks=break_pts_year) #vast majority of surveys from 1998 and 2005
dev.off()
setwd(main_working_directory)
```

```{r combined graph (lat, lon, month, yr)}
setwd(graphs_directory)
tiff("Reef Check Study Lat Lon Month Year Frequency Histogram.tif",res=300,width=2600,height=1000)
par(mfrow=c(2,2))
hist(na.omit(Reef_Check_Bleaching_Data$Latitude.Degrees), breaks=break_pts_lat, xlab="Latitude", main="")
hist(na.omit(Reef_Check_Bleaching_Data$Longitude.Degrees), breaks=break_pts_lon, xlab="Longitude", main="")
hist(na.omit(Reef_Check_Bleaching_Data$month), breaks=break_pts_month, xlab="Month", main="")
hist(na.omit(Reef_Check_Bleaching_Data$Year), breaks=break_pts_year, xlab="Year", main="")
dev.off()
setwd(main_working_directory)
```

sites_at_lat<-cbind(Reef_Check_Bleaching_Data$Reef.ID, Reef_Check_Bleaching_Data$Latitude.Degrees)
for (i in 1:(dim(sites_at_lat)[1])){
sites_at_lat[i]<-sites_at_lat[i]<-paste(sites_at_lat[i,1], "LAT", sites_at_lat[i,2], sep = "")
}
sites_at_lat<-sites_at_lat[,1]
sites_at_lat<-unique(sites_at_lat)
for (i in 1:length(sites_at_lat)){
sites_at_lat[i]<-str_split(sites_at_lat[i], "LAT")[[1]][2]
}
sites_at_lat<-as.numeric(sites_at_lat)

setwd(graphs_directory)
steps_lat<-5
break_pts_lat<-seq(floor(min(na.omit(Reef_Check_Bleaching_Data$Latitude.Degrees)))-.5, ceiling(max(na.omit(Reef_Check_Bleaching_Data$Latitude.Degrees)))+steps_lat+.5, steps_lat)
tiff("Reef Check Sites at Latitude Frequency Histogram.tif",res=300,width=1600,height=1200)
hist(sites_at_lat, xlab="Latitude", ylab="Number of Sites", breaks=break_pts_lat, main="")
dev.off()
setwd(main_working_directory)

sites_at_lat<-hist(sites_at_lat, xlab="Latitude", ylab="Number of Sites", breaks=break_pts_lat, main="")


sites_at_lon<-cbind(Reef_Check_Bleaching_Data$Reef.ID, Reef_Check_Bleaching_Data$Longitude.Degrees)
for (i in 1:(dim(sites_at_lon)[1])){
sites_at_lon[i]<-sites_at_lon[i]<-paste(sites_at_lon[i,1], "LON", sites_at_lon[i,2], sep = "")
}
sites_at_lon<-sites_at_lon[,1]
sites_at_lon<-unique(sites_at_lon)
for (i in 1:length(sites_at_lon)){
sites_at_lon[i]<-str_split(sites_at_lon[i], "LON")[[1]][2]
}
sites_at_lon<-as.numeric(sites_at_lon)

setwd(graphs_directory)
steps_lon<-5
break_pts_lon<-seq(floor(min(na.omit(Reef_Check_Bleaching_Data$Longitude.Degrees)))-.5, ceiling(max(na.omit(Reef_Check_Bleaching_Data$Longitude.Degrees)))+steps_lon+.5, steps_lon)
tiff("Reef Check Sites at Longitude Frequency Histogram.tif",res=300,width=1600,height=1200)
hist(sites_at_lon, xlab="Longitude", ylab="Number of Sites", breaks=break_pts_lon, main="")
dev.off()
setwd(main_working_directory)

#double check that it's unique.  unique(Reef_Check_Bleaching_Data$Reef.ID) is same length as  unique(sites_at_lat[,1]) is same length as unique(sites_at_lat[,1])


```{r Reef Check data pts on map}
setwd(graphs_directory)
Reef_Check_coordinates<-data.frame(Reef_Check_Bleaching_Data$Longitude.Degrees, Reef_Check_Bleaching_Data$Latitude.Degrees)
Reef_Check_coordinates_SpatialPoints<-SpatialPoints(Reef_Check_coordinates, proj4string=CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))
Reef_Check_coordinates_SpatialPoints_merc<-spTransform(Reef_Check_coordinates_SpatialPoints, CRS=CRS("+proj=merc +lon_0=150 +lat_ts=0 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs"))
par(mfrow=c(1,1))
tiff("Reef Check coordinates.tif",res=300,width=2600,height=1000)
plot(Reef_Check_coordinates_SpatialPoints_merc, col="red", pch=16, cex=.5, main="coordinates of all studies")
plot.map("world", center=0 ,bg="#00000000",ylim=c(-90,90),fill=FALSE,add=T,xlab='longitude',ylab='latitude') #center is still 0
plot(ECO, add=T)
box()
dev.off()
setwd(main_working_directory)
```

```{r map of ecoregions different colors}
setwd(graphs_directory)
tiff("Ecoregions.tif",res=300,width=4500,height=1500)
color_values= runif(length(levels(ECO$Ecoregion)), 67,137)
plot(ECO, col=color_values)
plot.map("world", center=0 ,bg="#00000000",ylim=c(-90,90),fill=FALSE,add=T,xlab='longitude',ylab='latitude')
box()
dev.off()

setwd(main_working_directory)
```

```{r percent bleached maps}

percent_bleached_brks<-c(0,20,40,60,80,100)
#percent_bleached_cols <- c(brewer.pal(5, "Reds"))
percent_bleached_cols <- c("#FCBBA1", "#FB6A4A", "#CB181D", "#A50F15", "#67000D")
percent_bleached_grps<-as.ordered(cut(as.matrix(Reef_Check_Bleaching_Data$Average_bleaching), percent_bleached_brks, include.lowest=TRUE,dig.lab=2))
Reef_Check_coordinates_percent_bleached<-data.frame(Reef_Check_Bleaching_Data$Longitude.Degrees, Reef_Check_Bleaching_Data$Latitude.Degrees, Reef_Check_Bleaching_Data$Average_bleaching)
Reef_Check_coordinates_percent_bleached_SpatialPoints<-SpatialPoints(na.omit(Reef_Check_coordinates_percent_bleached), proj4string=CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))
Reef_Check_coordinates_percent_bleached_SpatialPoints_merc<-spTransform(Reef_Check_coordinates_percent_bleached_SpatialPoints, CRS=CRS("+proj=merc +lon_0=150 +lat_ts=0 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs"))

setwd(graphs_directory)
tiff("Reef Check percent bleached per study.tif",res=300,width=4500,height=1500)
plot(Reef_Check_coordinates_percent_bleached_SpatialPoints_merc, col=percent_bleached_cols[unclass(percent_bleached_grps)], pch=16, cex=.8)
legend("topright",legend=c("[0,20]", "(20,40]", "(40,60]", "(60,80]", "(80,100]"), fill=percent_bleached_cols, bty="n",cex=1,y.intersp=0.8)
plot.map("world", center=0 ,bg="#00000000",ylim=c(-90,90),fill=FALSE,add=T,xlab='longitude',ylab='latitude') #center is still 0
plot(ECO, add=T)
box()
dev.off()
setwd(main_working_directory)

```

```{r percent bleaching per year map}
setwd(graphs_directory)
latlonyrpercent_bleached<-data.frame(Reef_Check_Bleaching_Data$Longitude.Degrees, Reef_Check_Bleaching_Data$Latitude.Degrees, Reef_Check_Bleaching_Data$Year, Reef_Check_Bleaching_Data$Average_bleaching)
latlonyrpercent_bleached_SpatialPoints<-SpatialPoints(na.omit(latlonyrpercent_bleached), proj4string=CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))
latlonyrpercent_bleached_SpatialPoints_merc<-spTransform(latlonyrpercent_bleached_SpatialPoints, CRS=CRS("+proj=merc +lon_0=150 +lat_ts=0 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs"))
percent_bleached_per_yr_brks<-c(-1,5,20,40,60,80,100)
percent_bleached_per_yr_labels<-c("[0-5]", "(5,20]", "(20,40]", "(40,60]", "(60,80]", "(80,100]")
percent_bleached_per_yr_cols <- c("blue", brewer.pal(5, "Reds"))
for (i in min(Reef_Check_Bleaching_Data$Year):max(Reef_Check_Bleaching_Data$Year)){
  rows<-which(Reef_Check_Bleaching_Data$Year==i)
  latlonyrpercent_bleached<-data.frame(lon=Reef_Check_Bleaching_Data$Longitude.Degrees[rows], lat=Reef_Check_Bleaching_Data$Latitude.Degrees[rows], yr=Reef_Check_Bleaching_Data$Year[rows], pb=Reef_Check_Bleaching_Data$Average_bleaching[rows])
  if ((dim(latlonyrpercent_bleached)[1]>0) & (sum(is.na(latlonyrpercent_bleached$pb))<dim(latlonyrpercent_bleached)[1])){
    latlonyrpercent_bleached_SpatialPoints<-SpatialPoints(na.omit(latlonyrpercent_bleached), proj4string=CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))
    latlonyrpercent_bleached_SpatialPoints_merc<-spTransform(latlonyrpercent_bleached_SpatialPoints, CRS=CRS("+proj=merc +lon_0=150 +lat_ts=0 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs"))
    percent_bleached_per_yr_grps<-cut(na.omit(Reef_Check_Bleaching_Data$Average_bleaching[rows]), percent_bleached_per_yr_brks, include.lowest=TRUE,dig.lab=2)
    title<-paste("Percent bleaching ", i, ".tif", sep="")
    tiff(title,res=300,width=2600,height=1000)
    plot(ECO, main=paste("Percent bleaching ",i, sep=""))
    plot(latlonyrpercent_bleached_SpatialPoints_merc, col=percent_bleached_per_yr_cols[unclass(percent_bleached_per_yr_grps)], pch=16, cex=1, add=T)
    legend("bottomright",legend=percent_bleached_per_yr_labels, fill=percent_bleached_per_yr_cols, bty="n",cex=1,y.intersp=0.8)
    legend("bottomleft", legend=paste("n=",dim(latlonyrpercent_bleached)[1]-sum(is.na(latlonyrpercent_bleached$pb))), bty="o",cex=1,y.intersp=0.8)
    plot.map("world", center=0 ,bg="#00000000",ylim=c(-90,90),fill=FALSE,add=T,xlab='longitude',ylab='latitude') #center is still 0
    dev.off()

  }
}
setwd(main_working_directory)
```

```{r histogram of percent bleaching per decade}
#percent bleaching frequency, split by decade.
setwd(graphs_directory)

decade_list<-matrix(data=c(1998,1998,1999,2004,2005,2005,2006,2011,2012,2017), nrow=5, ncol=2,byrow=TRUE)
increment=5
percent_bleaching_frequency_decade_brks<-seq(from=0, to=100, by=increment)
 
  for (i in 1:dim(decade_list)[1]){
  rows<-which(Reef_Check_Bleaching_Data$Year>=decade_list[i,1] & Reef_Check_Bleaching_Data$Year<=decade_list[i,2])
  percent_bleaching_frequency_decade<-data.frame(pb=Reef_Check_Bleaching_Data$Average_bleaching[rows])
  num_of_studies<-length(percent_bleaching_frequency_decade$pb)-sum(is.na(percent_bleaching_frequency_decade$pb))
  num_of_NA_studies<-sum(is.na(percent_bleaching_frequency_decade$pb))
  title<-paste("Percent bleaching frequency years ", decade_list[i,1], " to", decade_list[i,2], ".tif", sep="")
  tiff(title, res=300, width=2600, height=1000)
  hist(na.omit(percent_bleaching_frequency_decade$pb), freq=TRUE, xlim=range(percent_bleaching_frequency_decade_brks), xlab="% Bleached", ylab="Frequency", breaks=percent_bleaching_frequency_decade_brks, main=paste("Colony, Percent Bleaching Frequency years ", decade_list[i,1], " to ", decade_list[i,2], sep=""))
  legend("topright", legend=paste("n=", num_of_studies, "; NA's=", num_of_NA_studies, "; total=", (num_of_studies+num_of_NA_studies), " ", sep=""))
  dev.off()
  }
setwd(main_working_directory) 
```

```{r histogram of percent bleaching per decade, remove zero bleaching}
#percent bleaching frequency, split by decade.
setwd(graphs_directory)
decade_list<-matrix(data=c(1998,1999, 2000,2004, 2005,2006, 2007,2011, 2012,2017), nrow=5, ncol=2,byrow=TRUE)
increment=10
percent_bleaching_frequency_decade_brks<-seq(from=0, to=100, by=increment)

for (i in 1:dim(decade_list)[1]){
  rows<-which(Reef_Check_Bleaching_Data$Year>=decade_list[i,1] & Reef_Check_Bleaching_Data$Year<=decade_list[i,2] & Reef_Check_Bleaching_Data$Average_bleaching>1)
  percent_bleaching_frequency_decade<-data.frame(pb=c(Reef_Check_Bleaching_Data$S1[rows], Reef_Check_Bleaching_Data$S2[rows], Reef_Check_Bleaching_Data$S3[rows], Reef_Check_Bleaching_Data$S4[rows]))
  percent_bleaching_frequency_decade_remove_zeros<-subset(percent_bleaching_frequency_decade)
  num_of_studies<-length(percent_bleaching_frequency_decade$pb)-sum(is.na(percent_bleaching_frequency_decade$pb))
  num_of_NA_studies<-sum(is.na(percent_bleaching_frequency_decade$pb))
  title<-paste("Percent bleaching frequency years ", decade_list[i,1], " to", decade_list[i,2], ".tif", sep="")
  tiff(title, res=300, width=2600, height=1000)
  hist(na.omit(percent_bleaching_frequency_decade$pb), freq=TRUE, xlim=range(percent_bleaching_frequency_decade_brks), xlab="% Bleached", ylab="Frequency", breaks=percent_bleaching_frequency_decade_brks, main=paste("Percent Bleaching Frequency, all transects, years ", decade_list[i,1], " to ", decade_list[i,2], sep=""))
  legend("topright", legend=paste("n=", num_of_studies, "; NA's=", num_of_NA_studies, "; total=", (num_of_studies+num_of_NA_studies), " ", sep=""))
  dev.off()
}
setwd(main_working_directory)
```

```{r histogram of percent bleaching all years together}
#percent bleaching frequency, for all years collectively.
increment=10
percent_bleaching_frequency_brks<-seq(from=0, to=100, by=increment)

percent_bleaching_frequency<-data.frame(pb=Reef_Check_Bleaching_Data$Average_bleaching)
num_of_studies<-length(percent_bleaching_frequency$pb)-sum(is.na(percent_bleaching_frequency$pb))
num_of_NA_studies<-sum(is.na(percent_bleaching_frequency$pb))
setwd(graphs_directory)
title<-paste("Percent bleaching frequency grouped by ", increment, " percent.tif", sep="")
tiff(title, res=300, width=2600, height=1000)
hist(na.omit(percent_bleaching_frequency$pb), freq=TRUE, xlim=range(percent_bleaching_frequency_brks), xlab="% Bleached", ylab="Frequency", breaks=percent_bleaching_frequency_brks, main=paste("Percent Bleaching Frequency grouped by ", increment, " percent", sep=""))
legend("topright", legend=paste("n=", num_of_studies, "; NA's=", num_of_NA_studies, "; total=", (num_of_studies+num_of_NA_studies), " ", sep=""))
dev.off()
setwd(main_working_directory)
```

```{r histogram of percent bleaching all years together, remove zeros}
#percent bleaching frequency, for all years collectively.
increment=5
percent_bleaching_frequency_brks<-seq(from=0, to=100, by=increment)
rows<-which(Reef_Check_Bleaching_Data$Average_bleaching>1)
percent_bleaching_frequency<-data.frame(pb=Reef_Check_Bleaching_Data$Average_bleaching[rows])
num_of_studies<-length(percent_bleaching_frequency$pb)-sum(is.na(percent_bleaching_frequency$pb))
num_of_NA_studies<-sum(is.na(percent_bleaching_frequency$pb))
setwd(graphs_directory)
title<-paste("Percent bleaching frequency grouped by ", increment, " percent.tif", sep="")
tiff(title, res=300, width=2600, height=1000)
hist(na.omit(percent_bleaching_frequency$pb), freq=TRUE, xlim=range(percent_bleaching_frequency_brks), xlab="% Bleached", ylab="Frequency", breaks=percent_bleaching_frequency_brks, main=paste("Percent Bleaching Frequency grouped by ", increment, " percent", sep=""))
legend("topright", legend=paste("n=", num_of_studies, "; NA's=", num_of_NA_studies, "; total=", (num_of_studies+num_of_NA_studies), " ", sep=""))
dev.off()
setwd(main_working_directory)
```

```{r frequency of bleaching per year}
setwd(graphs_directory)
title<-paste("Percent bleaching frequency per year.tif", sep="")
tiff(title, res=300, width=2600, height=1000)
rows<-which(Reef_Check_Bleaching_Data$Average_bleaching>1)
bleach_frequency<-data.frame(yr=Reef_Check_Bleaching_Data$Year[rows])
hist(bleach_frequency, freq=TRUE, xlim=range(bleach_frequency), xlab="Year", main="number of zeros")
dev.off()
setwd(main_working_directory)
```

```{r proportion of bleaching per year}
setwd(graphs_directory)
title<-paste("Proportion bleaching per year.tif", sep="")
tiff(title, res=300, width=2600, height=1000)

year_list<-seq(from=min(Reef_Check_Bleaching_Data$Year), to=max(Reef_Check_Bleaching_Data$Year), by=1)  #few studies in years 1998 through 2002
bleaching_proportion_per_year<-array(data=NA,dim=length(year_list))
threshold<-0.1 #percent. ex. 1 for 1%, 50 for 50%
for (i in 1:length(year_list)){
  zero_bleaching_rows<-which(Reef_Check_Bleaching_Data$Year==year_list[i] & Reef_Check_Bleaching_Data$Average_bleaching<threshold)
  bleaching_rows<-which(Reef_Check_Bleaching_Data$Year==year_list[i] &  Reef_Check_Bleaching_Data$Average_bleaching>=threshold)
  bleaching_proportion_per_year[i]<-length(bleaching_rows)/(length(bleaching_rows)+length(zero_bleaching_rows))
}

par(mfrow=c(1,1))
  plot(x=year_list, y=bleaching_proportion_per_year, xlab="Year", ylab="proportion some bleaching", main=paste("proportion > ", threshold, "% bleach", sep=""), ylim=c(0,1))
dev.off()
setwd(main_working_directory)
```

```{r plot proportion binary bleaching per lat, lon, month, year}

break_pts_lat<-seq(-40, 40, 5)
studies_with_bleaching=subset(Reef_Check_Bleaching_Data, Average_bleaching>=1)
lat1<-hist(na.omit(Reef_Check_Bleaching_Data$Latitude.Degrees), breaks=break_pts_lat)
lat2<-hist(studies_with_bleaching$Latitude.Degrees, breaks=break_pts_lat)

steps_lon<-5
break_pts_lon<-seq(-180, 180, 10)
studies_with_bleaching=subset(Reef_Check_Bleaching_Data, Average_bleaching>=1)
lon1<-hist(na.omit(Reef_Check_Bleaching_Data$Longitude.Degrees), breaks=break_pts_lon)
lon2<-hist(studies_with_bleaching$Longitude.Degrees, breaks=break_pts_lon)

break_pts_month<-seq(-0.5, 12.5, 1)
studies_with_bleaching=subset(Reef_Check_Bleaching_Data, Average_bleaching>=1)
mon1<-hist(na.omit(Reef_Check_Bleaching_Data$month), breaks=break_pts_month)
mon2<-hist(studies_with_bleaching$month, breaks=break_pts_month)

break_pts_year<-seq(1997.5, 2017.5, 1)
studies_with_bleaching=subset(Reef_Check_Bleaching_Data, Average_bleaching>=1)
yr1<-hist(na.omit(Reef_Check_Bleaching_Data$Year), breaks=break_pts_year)
yr2<-hist(studies_with_bleaching$Year, breaks=break_pts_year)

setwd(graphs_directory)
tiff(filename=paste("binary_bleaching_frequency_histograms_lat_lon_mon_yr.tif"), res=300,width=2000,height=2000)
par(mfrow=c(2,2))
plot(lat1, xlab="Latitude", ylab="Frequency", main="", col="blue")
plot(lat2, col="red", add=T)
plot(lon1, xlab="Longitude", ylab="Frequency", main="", col="blue")
plot(lon2, col="red", add=T)
plot(mon1, xlab="Month", ylab="Frequency", main="", col="blue")
plot(mon2, col="red", add=T)
plot(yr1, xlab="Year", ylab="Frequency", main="", col="blue")
plot(yr2, col="red", add=T)
dev.off()
setwd(main_working_directory)

```

```{r plot severity bleaching per lat, lon, month, year}
#bleaching severity proportion per latitude, per longitude, per year, per month
Severity<-array(data=NA, dim=length(Reef_Check_Bleaching_Data$Average_bleaching))
for (i in 1:length(Reef_Check_Bleaching_Data$Average_bleaching)){
if(Reef_Check_Bleaching_Data$Average_bleaching[i]<1){Severity[i]=0}
if((Reef_Check_Bleaching_Data$Average_bleaching[i]>=1) & (Reef_Check_Bleaching_Data$Average_bleaching[i]<10)){Severity[i]=1}
if((Reef_Check_Bleaching_Data$Average_bleaching[i]>=10) & (Reef_Check_Bleaching_Data$Average_bleaching[i]<50)){Severity[i]=2}
if(Reef_Check_Bleaching_Data$Average_bleaching[i]>=50){Severity[i]=3}
}
Reef_Check_Bleaching_Data$Severity<-Severity

Bleaching_Data_Reef_Check_all= subset(Reef_Check_Bleaching_Data)
Bleaching_Data_Reef_Check_None=subset(Reef_Check_Bleaching_Data)
Bleaching_Data_Reef_Check_Mild<-subset(Reef_Check_Bleaching_Data, Severity>0)
Bleaching_Data_Reef_Check_Moderate<-subset(Reef_Check_Bleaching_Data, Severity>(1))
Bleaching_Data_Reef_Check_Severe<-subset(Reef_Check_Bleaching_Data, Severity>(2))
number_of_studies_Reef_Check=length(Reef_Check_Bleaching_Data$Severity)

break_pts_lat<-seq(-40, 40, 5)
lat0<-hist(na.omit(Bleaching_Data_Reef_Check_None$Latitude.Degrees), breaks=break_pts_lat)
lat1<-hist(na.omit(Bleaching_Data_Reef_Check_Mild$Latitude.Degrees), breaks=break_pts_lat)
lat2<-hist(na.omit(Bleaching_Data_Reef_Check_Moderate$Latitude.Degrees), breaks=break_pts_lat)
lat3<-hist(na.omit(Bleaching_Data_Reef_Check_Severe$Latitude.Degrees), breaks=break_pts_lat)

break_pts_lon<-seq(-180, 180, 10)
lon0<-hist(na.omit(Bleaching_Data_Reef_Check_None$Longitude.Degrees), breaks=break_pts_lon)
lon1<-hist(na.omit(Bleaching_Data_Reef_Check_Mild$Longitude.Degrees), breaks=break_pts_lon)
lon2<-hist(na.omit(Bleaching_Data_Reef_Check_Moderate$Longitude.Degrees), breaks=break_pts_lon)
lon3<-hist(na.omit(Bleaching_Data_Reef_Check_Severe$Longitude.Degrees), breaks=break_pts_lon)

break_pts_mon<-seq(-0.5, 12.5, 1)
mon0<-hist(na.omit(Bleaching_Data_Reef_Check_None$month), breaks=break_pts_mon)
mon1<-hist(na.omit(Bleaching_Data_Reef_Check_Mild$month), breaks=break_pts_mon)
mon2<-hist(na.omit(Bleaching_Data_Reef_Check_Moderate$month), breaks=break_pts_mon)
mon3<-hist(na.omit(Bleaching_Data_Reef_Check_Severe$month), breaks=break_pts_mon)

break_pts_yr<-seq(1997.5, 2017.5, 1)
yr0<-hist(na.omit(Bleaching_Data_Reef_Check_None$Year), breaks=break_pts_yr)
yr1<-hist(na.omit(Bleaching_Data_Reef_Check_Mild$Year), breaks=break_pts_yr)
yr2<-hist(na.omit(Bleaching_Data_Reef_Check_Moderate$Year), breaks=break_pts_yr)
yr3<-hist(na.omit(Bleaching_Data_Reef_Check_Severe$Year), breaks=break_pts_yr)

setwd(graphs_directory)
tiff(filename="bleaching_severity_frequency_histogram_lat.tif", res=400,width=2400,height=2400)
plot(lat0, xlab="Latitude", ylab="Number of surveys", main=NULL, col="blue")
legend("topright", c("None", "Mild", "Moderate", "Severe"), fill=c("blue", "pink", "red", "black"), bty="n")
plot(lat1, col="pink", add=T)
plot(lat2, col="red", add=T)
plot(lat3, col="black", add=T)
dev.off()

setwd(graphs_directory)
tiff(filename="bleaching_severity_frequency_histogram_lon.tif", res=400,width=3200,height=2400)
plot(lon0, xlab="Longitude", ylab="Number of surveys", main=NULL, col="blue")
legend("topright", c("None", "Mild", "Moderate", "Severe"), fill=c("blue", "pink", "red", "black"), bty="n")
plot(lon1, col="pink", add=T)
plot(lon2, col="red", add=T)
plot(lon3, col="black", add=T)
dev.off()


setwd(graphs_directory)
tiff(filename=paste("bleaching_severity_frequency_histograms_lat_lon_mon_yr.tif"), res=500,width=3000,height=3000)
par(mfrow=c(2,2))
plot(lat0, xlab="Latitude", ylab="Frequency", main=NULL, col="blue")
legend("topright", c("None", "Mild", "Moderate", "Severe"), fill=c("blue", "pink", "red", "black"), bty="n")
plot(lat1, col="pink", add=T)
plot(lat2, col="red", add=T)
plot(lat3, col="black", add=T)
plot(lon0, xlab="Longitude", ylab="Frequency", main=NULL, col="blue")
plot(lon1, col="pink", add=T)
plot(lon2, col="red", add=T)
plot(lon3, col="black", add=T)
plot(mon0, xlab="Month", ylab="Frequency", main=NULL, col="blue")
plot(mon1, col="pink", add=T)
plot(mon2, col="red", add=T)
plot(mon3, col="black", add=T)
plot(yr0, xlab="Year", ylab="Frequency", main=NULL, col="blue")
plot(yr1, col="pink", add=T)
plot(yr2, col="red", add=T)
plot(yr3, col="black", add=T)
dev.off()
setwd(main_working_directory)

```


```{r ks test of latitude differences 15-20 lats and everything else and N vs S}
num_bleaching_15_to_20_lats<-sum(lat1$counts[abs(lat1$mids)==17.5]) #817
num_nonbleaching_15_to_20_lats<-sum(lat0$counts[abs(lat0$mids)==17.5])-sum(lat1$counts[abs(lat1$mids)==17.5]) #1754
num_severe_bleaching_15_to_20_lats<-sum(lat3$counts[abs(lat3$mids)==17.5]) #49
num_moderate_bleaching_15_to_20_lats<-sum(lat2$counts[abs(lat2$mids)==17.5])-num_severe_bleaching_15_to_20_lats  #189
num_mild_bleaching_15_to_20_lats<-sum(lat1$counts[abs(lat1$mids)==17.5])-num_severe_bleaching_15_to_20_lats-num_moderate_bleaching_15_to_20_lats #579


num_bleaching_other_lats<-sum(lat1$counts[abs(lat1$mids)!=17.5]) #1398
num_nonbleaching_other_lats<-sum(lat0$counts[abs(lat0$mids)!=17.5])-sum(lat1$counts[abs(lat1$mids)!=17.5]) #5246
num_severe_bleaching_other_lats<-sum(lat3$counts[abs(lat3$mids)!=17.5]) #57
num_moderate_bleaching_other_lats<-sum(lat2$counts[abs(lat2$mids)!=17.5])-num_severe_bleaching_other_lats  #342
num_mild_bleaching_other_lats<-sum(lat1$counts[abs(lat1$mids)!=17.5])-num_severe_bleaching_other_lats-num_moderate_bleaching_other_lats #999


num_bleaching_N_lats<-sum(lat1$counts[lat1$mids>0]) #1456
num_nonbleaching_N_lats<-sum(lat0$counts[lat0$mids>0])-sum(lat1$counts[lat1$mids>0]) # 4804
num_bleaching_S_lats<-sum(lat1$counts[lat1$mids<0]) #759
num_nonbleaching_S_lats<-sum(lat0$counts[lat0$mids<0])-sum(lat1$counts[lat1$mids<0]) #2196

#compare bleaching and nonbleaching N vs S lats
lats_N<-c(rep(1, times=num_bleaching_N_lats), rep(0, times=num_nonbleaching_N_lats))
lats_S<-c(rep(1, times=num_bleaching_S_lats), rep(0, times=num_nonbleaching_S_lats))

ks.test(lats_N, lats_S)
ks.test(lats_N, lats_S, alternative="greater")

#comare bleaching and nonbleaching at 15-20 lats vs other lats
lats_15_to_20<-c(rep(1, times=num_bleaching_15_to_20_lats), rep(0, times=num_nonbleaching_15_to_20_lats))
lats_other<-c(rep(1, times=num_bleaching_other_lats), rep(0, times=num_nonbleaching_other_lats))
ks.test(lats_15_to_20, lats_other) # D=0.10736, p-value<2.2e-16, p-value is small, so conclude that the two groups were sampled from populations with different distributions
ks.test(lats_15_to_20, lats_other, alternative="greater") #D^+ = 7.481e-18, p-value = 1
ks.test(lats_other, lats_15_to_20, alternative="greater") #D^+=0.10736, p-value<2.2e-16



#comare severity bleaching levels at 15-20 lats vs other lats
lats_15_to_20<-c(rep(0, times=num_nonbleaching_15_to_20_lats), rep(1, times=num_mild_bleaching_15_to_20_lats), rep(2, times=num_moderate_bleaching_15_to_20_lats), rep(3, times=num_severe_bleaching_15_to_20_lats))
lats_other<-c(rep(0, times=num_nonbleaching_other_lats), rep(1, times=num_mild_bleaching_other_lats), rep(2, times=num_moderate_bleaching_other_lats), rep(3, times=num_severe_bleaching_other_lats))
ks.test(lats_15_to_20, lats_other)   #gave exact same results, which seems odd, oh wait no it's not weird because zeros vs nonzeros are still the same, and because the nozeros show no differnce in the analyses below. conclude that the two groups were sampled from populations with different distributions

#compare mild vs moderate vs severe bleaching
lats_15_to_20<-c(rep(1, times=num_mild_bleaching_15_to_20_lats), rep(2, times=num_moderate_bleaching_15_to_20_lats), rep(3, times=num_severe_bleaching_15_to_20_lats))
lats_other<-c(rep(1, times=num_mild_bleaching_other_lats), rep(2, times=num_moderate_bleaching_other_lats), rep(3, times=num_severe_bleaching_other_lats))
ks.test(lats_15_to_20, lats_other) #D=0.019203, p-value=.9913  so conclude that (when we ignore nonbleaching) the bleaching severity level has the same distribution when comparing 15-20 lats vs other lats

#compare mild vs (combination of moderate or severe)
lats_15_to_20<-c(rep(1, times=num_mild_bleaching_15_to_20_lats), rep(2, times=(num_moderate_bleaching_15_to_20_lats+num_severe_bleaching_15_to_20_lats)))
lats_other<-c(rep(1, times=num_mild_bleaching_other_lats), rep(2, times=(num_moderate_bleaching_other_lats+num_severe_bleaching_other_lats)))
ks.test(lats_15_to_20, lats_other) #D=0.0059019 p-value=1


#compare (combination of mild or moderate) vs severe
lats_15_to_20<-c(rep(1, times=(num_mild_bleaching_15_to_20_lats+num_moderate_bleaching_15_to_20_lats)), rep(2, times=num_severe_bleaching_15_to_20_lats))
lats_other<-c(rep(1, times=num_mild_bleaching_other_lats+num_moderate_bleaching_other_lats), rep(2, times=num_severe_bleaching_other_lats))
ks.test(lats_15_to_20, lats_other) #D=0.019203 p-value=.9913



#compare 10-15 lats vs 15-20 lats
num_bleaching_10_to_15_lats<-sum(lat1$counts[abs(lat1$mids)==12.5]) #453
num_nonbleaching_10_to_15_lats<-sum(lat0$counts[abs(lat0$mids)==12.5])-sum(lat1$counts[abs(lat1$mids)==12.5]) #1325

num_bleaching_15_to_20_lats<-sum(lat1$counts[abs(lat1$mids)==17.5]) #817
num_nonbleaching_15_to_20_lats<-sum(lat0$counts[abs(lat0$mids)==17.5])-sum(lat1$counts[abs(lat1$mids)==17.5]) #1754

lats_10_to_15<-c(rep(1, times=num_bleaching_10_to_15_lats), rep(0, times=num_nonbleaching_10_to_15_lats))
lats_15_to_20<-c(rep(1, times=num_bleaching_15_to_20_lats), rep(0, times=num_nonbleaching_15_to_20_lats))
ks.test(lats_10_to_15, lats_15_to_20) # D=0.062995, p-value<.0004765
ks.test(lats_10_to_15, lats_15_to_20, alternative="greater") #D^+ = 0.062995, p-value = 0.0002382
ks.test(lats_15_to_20, lats_10_to_15, alternative="greater") #D^+ = -8.9664e-17, p-value = 1

#compare positive 10-15 lats vs positive 15-20 lats
num_bleaching_10_to_15_lats<-sum(lat1$counts[lat1$mids==12.5]) #411
num_nonbleaching_10_to_15_lats<-sum(lat0$counts[lat0$mids==12.5])-sum(lat1$counts[lat1$mids==12.5]) #1079

num_bleaching_15_to_20_lats<-sum(lat1$counts[lat1$mids==17.5]) #449
num_nonbleaching_15_to_20_lats<-sum(lat0$counts[lat0$mids==17.5])-sum(lat1$counts[lat1$mids==17.5]) #757

lats_10_to_15<-c(rep(1, times=num_bleaching_10_to_15_lats), rep(0, times=num_nonbleaching_10_to_15_lats))
lats_15_to_20<-c(rep(1, times=num_bleaching_15_to_20_lats), rep(0, times=num_nonbleaching_15_to_20_lats))
ks.test(lats_10_to_15, lats_15_to_20) #D=0.096466, p-value=8.197e-06
ks.test(lats_10_to_15, lats_15_to_20, alternative="greater") #D^+=0.096466, p-value=4.098e-06
ks.test(lats_15_to_20, lats_10_to_15, alternative="greater") #D^+=7.8496e-17, p-value=1


#compare negative 15-20 lats vs positive 15-20 lats
num_bleaching_positive_15_to_20_lats<-sum(lat1$counts[lat1$mids==17.5]) #449
num_nonbleaching_positive_15_to_20_lats<-sum(lat0$counts[lat0$mids==17.5])-sum(lat1$counts[lat1$mids==17.5]) #757

num_bleaching_negative_15_to_20_lats<-sum(lat1$counts[lat1$mids==(-17.5)]) #368
num_nonbleaching_negative_15_to_20_lats<-sum(lat0$counts[lat0$mids==(-17.5)])-sum(lat1$counts[lat1$mids==(-17.5)]) #997

lats_positive_15_to_20<-c(rep(1, times=num_bleaching_positive_15_to_20_lats), rep(0, times=num_nonbleaching_positive_15_to_20_lats))
lats_negative_15_to_20<-c(rep(1, times=num_bleaching_negative_15_to_20_lats), rep(0, times=num_nonbleaching_negative_15_to_20_lats))
ks.test(lats_positive_15_to_20, lats_negative_15_to_20) # D=0.10271, p-value=2.718e-06
ks.test(lats_positive_15_to_20, lats_negative_15_to_20, alternative="greater") #D^+=2.537e-17, p-value=1
ks.test(lats_negative_15_to_20, lats_positive_15_to_20, alternative="greater") #D^+=0.10271, p-value=1.359e-06


#compare number of sites at 15-20 lat with number of sites at other lats
lat_sites<-hist(na.omit(sites_at_lat), xlab="Latitude", ylab="Number of Sites", breaks=break_pts_lat, main="")
sites_at_15_to_20<-c(lat_sites$counts[lat_sites$mids==(-17)], lat_sites$counts[lat_sites$mids==18])
sites_at_all_lats<-lat_sites$counts[1:(length(lat_sites$counts)-1)]
num_bleaching_15_to_20_lats<-sum(lat1$counts[abs(lat1$mids)==17.5]) #817


percent_bleaching_at_lat<-lat1$counts/lat0$counts
for (i in 1:length(percent_bleaching_at_lat)){
  if (is.na(percent_bleaching_at_lat[i])){
    percent_bleaching_at_lat[i]<-0
  }
}
percent_bleaching_at_lat<-percent_bleaching_at_lat[3:15]
lat_sites_counts<-lat_sites$counts[3:15]
MyVar<-c("percent_bleaching_at_lat", "lat_sites_counts")
library(Hmisc)
res<- as.matrix(Bleaching_Data_with_cortad_variables[,MyVar])
res2<-cor(res)
library(corrplot)
corrplot(res2)


sites_at_lat<-hist(sites_at_lat, xlab="Latitude", ylab="Number of Sites", breaks=break_pts_lat, main="")
sites_at_lat_vector<-sites_at_lat$counts[1:13]
#it was quicker to just do this manually...
sites_at_lat_order<-c(2,5,10,3,7,3,9,11,12,13,8,6,1)
percent_bleaching_at_lat_order<-c(13,6,9,3,8,11,5,7,10,12,4,2,1)

cor.test(x=sites_at_lat_vector, y=percent_bleaching_at_lat)

#get rid of ties?
#spearman (cor(bleaching, number_of_sites))
cor.test(x=percent_bleaching_at_lat_order, y=sites_at_lat_order, method="spearman", exact=FALSE)

```

```{r plot severity bleaching levels on map}
Reef_Check_Bleaching_Data$Severity<-Severity

brks<-c(0,.9999,9.9999,49.9999,100)
grps<-(cut(Reef_Check_Bleaching_Data$Average_bleaching, brks, include.lowest=TRUE))
cols<-c("blue", "pink", "red", "black")
#Population Reef Check study coordinates
Reef_Check_coordinates<-data.frame(Reef_Check_Bleaching_Data$Longitude.Degrees, Reef_Check_Bleaching_Data$Latitude.Degrees)
Reef_Check_coordinates_SpatialPoints<-SpatialPoints(Reef_Check_coordinates, proj4string=CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))
Reef_Check_coordinates_SpatialPoints_merc<-spTransform(Reef_Check_coordinates_SpatialPoints, CRS=CRS("+proj=merc +lon_0=150 +lat_ts=0 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs"))
par(mfrow=c(1,1))
setwd(graphs_directory)
tiff("Reef Check Population coordinates bleaching severity.tif",res=300, width=2600, height=1000)
par(mai=c(.1,.1,.1,.1))
plot(Reef_Check_coordinates_SpatialPoints_merc, col=cols[unclass(grps)], pch=16, cex=1)
plot.map("world", center=0 ,bg="#00000000",ylim=c(-90,90),fill=FALSE,add=T,xlab='longitude',ylab='latitude') #center is still 0
box()
legend("topright",legend=c("No bleaching", "[1-10%)", "[10-50%)", "[50,100%]"), fill=cols,border = "black", bty="o",bg='white',cex=1,y.intersp=0.8)
axis(1,at=c(-16654136,(-16654136+111319.4*90),(-16654136+111319.4*180),(-16654136+111319.4*270),(-16654136+111319.4*360)),labels=c("",'','','',''), tck = .025,mgp=c(3,.2,0),cex.axis=.65)
mtext("90", 1, line=-1.3, adj=0.335,cex=.65)
mtext('270',1,line=-1.3,adj=0.837,cex=.65)
axis(2,at=c(-1715153*2,-1715153,0,1715153,1715153*2),labels=c('','','','',''), tck = .025,mgp=c(3,.27,0),cex.axis=.65)
mtext("-15", 2, line=-1, adj=0.334,cex=.65)
mtext('15',2,line=-1,adj=0.664,cex=.65)
dev.off()
setwd(main_working_directory)

```

```{r depth frequency histogram}
steps_depth<-1
break_pts_depth<-seq(0, ceiling(max(Reef_Check_Bleaching_Data$Depth)), steps_depth)
setwd(graphs_directory)
tiff("Reef Check Depth Frequency Histogram.tif",res=300,width=2600,height=1000)
hist(na.omit(Reef_Check_Bleaching_Data$Depth), xlab="Depth (m)", ylab="Frequency", main="Depth Frequency", breaks=break_pts_depth)
dev.off()
setwd(main_working_directory)
```

```{r percent bleaching at depth, dot plot}
setwd(graphs_directory)
tiff("Percent Bleaching at Depth.tif",res=300,width=2600,height=1000)
plot(x=Reef_Check_Bleaching_Data$Depth, xlim=c(0,25), xlab="Depth", y=Reef_Check_Bleaching_Data$Average_bleaching, ylab="Percent Bleached", main="Percent Bleached at Depth, in each study", pch=16, cex=0.2)
legend("bottomright",legend="1 point for each study", fill="black", border="black", bg='white', bty="o",cex=.7,y.intersp=0.8)
dev.off()
setwd(main_working_directory)
```

#Fitting the data into the ecoregions and checking for mean bleaching and variance
```{r fit data into ecoregions}
library(raster)
#ECO<-ecos

par(mar=c(.1,.1,.1,.1))
proj4string(ECO)

coordinates(Reef_Check_Bleaching_Data)<- ~Longitude.Degrees+Latitude.Degrees
proj4string(Reef_Check_Bleaching_Data)<-"+proj=longlat +ellps=WGS84 +datum=WGS84"
bldata<-spTransform(Reef_Check_Bleaching_Data,proj4string(ECO))

#Make sure data is in ecoregions
test=bldata[ECO,]
#plot(test)
#plot(ECO, add=T)
## spatial overlay
test<-over(ECO,bldata,returnList = T) #finds ecoregion each point belongs to

#count number of studies for each ecoregion
num_studies_in_ecoregion<-array(data=0,dim=150)
for (i in 1:150){
 num_studies_in_ecoregion[i]<-dim(test[[i]])[1] 
}

#percent bleaching per ecoregion over time
setwd(graphs_directory)
year_list<-seq(from=min(Reef_Check_Bleaching_Data$Year), to=max(Reef_Check_Bleaching_Data$Year), by=1)  #few studies in years 1998 through 2002
#year_list<-seq(from=2002, to=2017, by=1)
threshold<-0.1 #percent. ex. 1 for 1%, 50 for 50%
par(mfrow=c(1,1))
par(mai=c(1.02,0.82,0.82,0.42))
for (j in 1:150){
  ecoregion_bleaching_data<-test[[j]]
  ecoregion_bleaching_proportion_per_year<-array(data=NA,dim=length(year_list))
  studies_in_ecoregion_in_year<-array(data=0, dim=length(year_list))
  for (i in 1:length(year_list)){
  ecoregion_zero_bleaching_rows<-which(ecoregion_bleaching_data$Year==year_list[i] & ecoregion_bleaching_data$Average_bleaching<threshold)
  ecoregion_bleaching_rows<-which(ecoregion_bleaching_data$Year==year_list[i] & ecoregion_bleaching_data$Average_bleaching>=threshold)
  
  ecoregion_bleaching_proportion_per_year[i]<-length(ecoregion_bleaching_rows)/(length(ecoregion_bleaching_rows)+length(ecoregion_zero_bleaching_rows))
  studies_in_ecoregion_in_year[i]<-length(ecoregion_bleaching_rows)+length(ecoregion_zero_bleaching_rows)
  }
  tiff(paste("Reef Check proportion bleaching ecoregion ", j, " ", ECO$Ecoregion[j], ".tif", sep=""),res=300,width=2600,height=1000)
  plot(x=year_list, y=ecoregion_bleaching_proportion_per_year, xlab="Year", ylab="proportion of pop. experiencing any bleaching", main=paste(ECO$Ecoregion[j], " ecoregion ", j," population proportion > ", threshold, "% bleach", sep=""),  ylim=c(0,1))
text(year_list, ecoregion_bleaching_proportion_per_year, labels=studies_in_ecoregion_in_year, cex= 0.7, pos=2)
  title<-dim(ecoregion_bleaching_data)[1]
  legend("topright", legend=paste("n=", title, sep=""))
  dev.off()
}

setwd(graphs_directory)
for (j in 1:150){
  ecoregion_bleaching_data<-test[[j]]
  mean_in_ecoregion_per_year<-array(data=NA,dim=length(year_list))
  variance_in_ecoregion_per_year<-array(data=NA,dim=length(year_list))
  number_studies_in_ecoregion_in_year<-array(data=0, dim=length(year_list))
  for (i in 1:length(year_list)){
    ecoregion_rows<-which(ecoregion_bleaching_data$Year==year_list[i])
    number_studies_in_ecoregion_in_year[i]<-length(ecoregion_rows)
    mean_in_ecoregion_per_year[i]<-mean(ecoregion_bleaching_data[ecoregion_rows,]$Average_bleaching/100, na.rm=T)
    variance_in_ecoregion_per_year[i]<-var(ecoregion_bleaching_data[ecoregion_rows,]$Average_bleaching/100, na.rm=T)
  }
  
  mean_max<-.1
  if(sum(is.na(mean_in_ecoregion_per_year))<length(mean_in_ecoregion_per_year)){mean_max<-max(mean_in_ecoregion_per_year,na.rm=T)}
  tiff(paste("Reef Check ecoregion ", j, " ", ECO$Ecoregion[j], " bleaching mean.tif", sep=""),res=300,width=2600,height=1000)
  plot(x=year_list, y=mean_in_ecoregion_per_year, xlab="Year", ylab="mean bleaching", main=paste(ECO$Ecoregion[j], " ecoregion ", j," mean bleaching", sep=""),  ylim=c(0,mean_max))
text(year_list, mean_in_ecoregion_per_year, labels=number_studies_in_ecoregion_in_year, cex= 0.7, pos=2)
  title<-dim(ecoregion_bleaching_data)[1]
  legend("topright", legend=paste("n=", title, sep=""))
  dev.off()
  
  var_max<-.1
  if(sum(is.na(variance_in_ecoregion_per_year))<length(variance_in_ecoregion_per_year)){var_max<-max(variance_in_ecoregion_per_year,na.rm=T)}
  tiff(paste("Reef Check ecoregion ", j, " ", ECO$Ecoregion[j], " bleaching variance.tif", sep=""),res=300,width=2600,height=1000)
  plot(x=year_list, y=variance_in_ecoregion_per_year, xlab="Year", ylab="variance bleaching", main=paste(ECO$Ecoregion[j], " ecoregion ", j," variance bleaching", sep=""),  ylim=c(0,var_max))
text(year_list, variance_in_ecoregion_per_year, labels=number_studies_in_ecoregion_in_year, cex= 0.7, pos=2)
  title<-dim(ecoregion_bleaching_data)[1]
  legend("topright", legend=paste("n=", title, sep=""))
  dev.off()
}

setwd(graphs_directory)
for (i in 1:length(year_list)){
  mean_in_ecoregion_per_year<-array(data=NA,dim=150)
  variance_in_ecoregion_per_year<-array(data=NA,dim=150)
  number_studies_in_ecoregion_in_year<-array(data=0, dim=150)
  for (j in 1:150){
    ecoregion_bleaching_data<-test[[j]]
    ecoregion_rows<-which(ecoregion_bleaching_data$Year==year_list[i])
    number_studies_in_ecoregion_in_year[j]<-length(ecoregion_rows)
    mean_in_ecoregion_per_year[j]<-mean(ecoregion_bleaching_data[ecoregion_rows,]$Average_bleaching/100, na.rm=T)
    variance_in_ecoregion_per_year[j]<-var(ecoregion_bleaching_data[ecoregion_rows,]$Average_bleaching/100, na.rm=T)
  }
  
  ECO@data<-as.data.frame(cbind(ECO@data,mean_in_ecoregion_per_year))
  ECO@data<-as.data.frame(cbind(ECO@data,variance_in_ecoregion_per_year))
} 

# Plot mean bleaching
library(RColorBrewer)
year<-1998
for (i in 0:19){
tiff(paste("Reef Check mean bleaching ", year, ".tif", sep=""),res=300,width=2600,height=1000)
M=ECO@data[,(2*i+3)]
#nsteps <- 10; step<-(max(M,na.rm=T)-min(M,na.rm=T))/nsteps
nsteps <- 10; step<-.1;
#brks<-(min(M,na.rm=T)+(0:nsteps)*step); brks[1]<- 0;
brks<-seq(from=0, to=1, by=.1);
#cols <- c(rev(brewer.pal(5, "Blues")), brewer.pal(5, "Reds"))
cols <- c("white", brewer.pal(9, "Reds"))
if (sum(is.na(M))<150){
   grps<-as.ordered(cut(M, brks, include.lowest=TRUE))
   par(mai=c(1.02,0.82,0.82,0.42))
   plot(ECO, col=cols[unclass(grps)], main=paste("mean bleaching ", year,sep=""))
   box();
   legend("bottomleft",legend=levels(grps), fill=cols, bty="n",cex=0.7,y.intersp=0.8)
 }
dev.off()

tiff(paste("Reef Check variance bleaching ", year, ".tif", sep=""),res=300,width=2600,height=1000)
V=ECO@data[,(2*i+4)]
#nsteps <- 10; step<-(max(V,na.rm=T)-min(V,na.rm=T))/nsteps
nsteps <- 10; step<-.1;
#brks<-(min(V,na.rm=T)+(0:nsteps)*step); brks[1]<- 0;
brks<-seq(from=0, to=.01, by=.001); brks[11]<-1;
#cols <- c(rev(brewer.pal(5, "Blues")), brewer.pal(5, "Reds"))
cols <- c("white", brewer.pal(10, "Reds"))
if (sum(is.na(V))<150){
  grps<-as.ordered(cut(V, brks, include.lowest=TRUE))
  par(mai=c(1.02,0.82,0.82,0.42))
  plot(ECO, col=cols[unclass(grps)], main=paste("variance bleaching ", year,sep=""))
  box();
  legend("bottomleft",legend=levels(grps), fill=cols, bty="n",cex=0.7,y.intersp=0.8)
 }
dev.off()
  
 year=year+1
 }

# Read bleaching data for each ecoregion
meanblch<-mean(test[[1]]$Average_bleaching,na.rm=T)
for(i in 2:150){
  meanblch<-c(meanblch,mean(test[[i]]$Average_bleaching,na.rm=T))
}
ECO@data<-as.data.frame(cbind(ECO@data,meanblch))

###Variance
varblch<-var(test[[1]]$Average_bleaching,na.rm=T)
for(i in 2:150){
  varblch<-c(varblch,var(test[[i]]$Average_bleaching,na.rm=T))
}
ECO@data<-as.data.frame(cbind(ECO@data,varblch))

setwd(main_working_directory)
```

```{r plot number of studies per ecoregion}
setwd(graphs_directory)
#count number of studies for each ecoregion
num_studies_in_ecoregion<-array(data=0,dim=150)
for (i in 1:150){
 num_studies_in_ecoregion[i]<-dim(test[[i]])[1] 
}

D=num_studies_in_ecoregion
brks<-c(0,1,100,200,300,400,500,600,700,800,900,1000)
cols <- c("white", brewer.pal(9, "Blues"))
grps<-as.ordered(cut(D, brks, include.lowest=TRUE))

setwd(graphs_directory)
tiff(file='Number_of_studies_per_ecoregion_ggplot.tif',height=1000,width=3000,res=300)
#par(mfrow=c(2,1),mgp=c(0.5,0.6,0))
par(mfrow=c(1,1),mgp=c(0.5,0.6,0))
plot.map("world", center=0 , ylim=c(-5500000,5500000), fill=T, col="grey90",border='grey70',mar=c(4,4,1,18)) #center is still 0
plot(ECO, ylim=c(-5500000,5500000), col=cols[unclass(grps)],add=T,lwd=.5)
box()
axis(1,at=c(-16654136,(-16654136+111319.4*90),(-16654136+111319.4*180),(-16654136+111319.4*270),(-16654136+111319.4*360)),labels=c("",'','','',''), tck = .025,mgp=c(3,.2,0),cex.axis=.65)
mtext("90°", 1, line=-1.3, adj=0.335,cex=.65)
mtext('270°',1,line=-1.3,adj=0.837,cex=.65)

axis(2,at=c(-1715153*2,-1715153,0,1715153,1715153*2),labels=c('','','','',''), tck = .025,mgp=c(3,.27,0),cex.axis=.65)
mtext("-15°", 2, line=-1, adj=0.334,cex=.65)
mtext('15°',2,line=-1,adj=0.664,cex=.65)

par(xpd=TRUE)
legend("topright",inset=c(-.16,0),legend=c("0", "1-100", "101-200", "201-300", "301-400", "401-500", "501-600", "601-700"), fill=cols,border = "black", bty="o",bg='white',cex=.7,y.intersp=0.8)

par(xpd=FALSE)
axis(3,at=c(-16654136,(-16654136+111319.4*90),(-16654136+111319.4*180),(-16654136+111319.4*270),(-16654136+111319.4*360)),labels=c("",'','','',''), tck = .025,mgp=c(3,.2,0),cex.axis=.65)
axis(4,at=c(-1715153*2,-1715153,0,1715153,1715153*2),labels=c('','','','',''), tck = .025,mgp=c(3,.27,0),cex.axis=.65)

windowsFonts(A=windowsFont('Arial Unicode MS'))
text(-7868896,-2922012,'Indian Ocean',cex=0.7,family='A')
text(9438742,487176,'Pacific Ocean',cex=0.7,family='A')
scalebar(d=4000000,xy=c(7095760,-4712655),label=c(0,'',4000),cex=.6,type='bar',divs=4,below="kilometers",adj=c(0.5,-1.1))
north.arrow(x=(-16654136+111319.4*320), y=1615153*2, len=(111319.4*2), lab="N", cex=.7)

dev.off()






# #attempt with ggplot
# wrld2 <- map_data('world2')
# 
# data_prez <- num_studies_in_ecoregion
# pal <- wes_palette(250, name = "Zissou1", type = "continuous")
# 
# #tiff(file='num_studies_per_ecoregion_Sep_20_2018.tif',height=2000,width=4000,res=300)
# 
# bleach.map <- ggplot() + 
#   geom_polygon(data = wrld2, aes(x=long, y = lat, group = group)
#                , fill='grey90', col='grey70', size=0.5) + 
#   coord_fixed(ratio=1) + # maintains ratio of x to y in plot regardless of plot size
#   coord_fixed(ylim=c(-33,35),xlim=c(15,316)) +
#   # theme_void() + # suppress axes
#   scale_x_continuous(breaks=c(60,120,180,240,300),labels= c('60°','120°','180°','-120°','-60°'),sec.axis = dup_axis())  +
#   scale_y_continuous(breaks=c(-25,0,25),labels= c('-23°','0°','23°'),sec.axis = dup_axis())  +
#   theme(legend.text = element_text(size = 12), legend.title=element_text(size=12), 
#         panel.border = element_rect(colour = "black", fill=NA, size=1),
#         axis.title.x = element_blank(), axis.title.y = element_blank(),
#         axis.line.x = element_blank(), axis.line.y = element_blank()) +
#   panel_border(colour = "black", size = 1, linetype = 1,remove = FALSE)
# 
# bleach.map +
#   geom_polygon(data = ECO, aes(x=long, y = lat, group = group)
#                , fill=num_studies_in_ecoregion, col='grey70', size=0.5) +
#   scale_colour_gradientn(colours=c("white", "#3B9AB2", "#78B7C5", "#EBCC2A", "#E1AF00", "#F21A00"), name='Bleaching %', trans='sqrt',
#   #scale_colour_gradientn(colours=c("white", "#3B9AB2", "#78B7C5", "gold", "#E1AF00","darkorange", "#F21A00", "red3", "darkred"), name='Bleaching %', trans='sqrt',
#                          breaks=c(0,2.2,100,300,500,700), labels=c(0,2.2,100,300,500,700))
# 
# #dev.off()
setwd(main_working_directory)


```

```{r plot mean bleaching}
# Plot mean bleaching
setwd(graphs_directory)
tiff(paste("Reef Check mean bleaching per ecoregion.tif", sep=""),res=300,width=2600,height=1000)
library(RColorBrewer)
D= ECO$meanblch
nsteps <- 10; step<-(max(D,na.rm=T)-min(D,na.rm=T))/nsteps
brks<-(min(D,na.rm=T)+(0:nsteps)*step); brks[1]<- 0;
#cols <- c(rev(brewer.pal(5, "Blues")), brewer.pal(5, "Reds"))
cols <- c("white", brewer.pal(9, "Reds"))
grps<-as.ordered(cut(D, brks, include.lowest=TRUE))
par(mai=c(1.02,0.82,0.82,0.42))
plot(ECO, col=cols[unclass(grps)])
box();
legend("bottomleft",legend=levels(grps), fill=cols, bty="n",cex=0.7,y.intersp=0.8)
dev.off()
setwd(main_working_directory)
```

```{r plot bleaching variance}
#plot bleaching variance
setwd(graphs_directory)
tiff(paste("Reef Check bleaching variance per ecoregion.tif", sep=""),res=300,width=2600,height=1000)
D= ECO$varblch
nsteps <- 10; step<-(max(D,na.rm=T)-min(D,na.rm=T))/nsteps
brks<-(min(D,na.rm=T)+(0:nsteps)*step); brks[1]<- 0;
#cols <- c(rev(brewer.pal(5, "Blues")), brewer.pal(5, "Reds"))
cols <- c("white", brewer.pal(9, "Reds"))
grps<-as.ordered(cut(D, brks, include.lowest=TRUE))
par(mai=c(1.02,0.82,0.82,0.42))
plot(ECO, col=cols[unclass(grps)])
box();
legend("bottomleft",legend=levels(grps), fill=cols, bty="n",cex=0.7,y.intersp=0.8)
dev.off()
setwd(main_working_directory)

```

```{r examine where we have no data}
#################
#Examine where we have no data (dark blue)
setwd(graphs_directory)
tiff(paste("Reef Check study ecoregions.tif", sep=""),res=300,width=2600,height=1000)
sum(!is.na(meanblch)) # have data from 73 of the 150 ecoregions
ECO$meanblch[ECO$meanblch > 0] = 1 #change all >0 to 1
ECO$meanblch[ECO$meanblch < 0] =0
ECO$meanblch[is.na(ECO$meanblch)] <- 0 # change NA to zero

D= ECO$meanblch
nsteps <- 2; step<-1
brks<-c(-.5,.5,1.5); #brks[1]<- 0;
cols <- c("Blue","Red")
grps<-as.ordered(cut(D, brks, include.lowest=TRUE))
par(mai=c(1.02,0.82,0.82,0.42))
plot(ECO, col=cols[unclass(grps)])
box();
legend("bottomleft",legend=levels(grps), fill=cols, bty="n",cex=0.7,y.intersp=0.8)
dev.off()
setwd(main_working_directory)

```